<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Search</title>
    <link rel="icon" href="../assets/logos/Title.png"
          type="image/x-icon">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://code.jquery.com/mobile/1.4.5/jquery.mobile-1.4.5.min.css"/>
    <script src="https://code.jquery.com/jquery-1.11.1.min.js"></script>
    <script src="https://code.jquery.com/mobile/1.4.5/jquery.mobile-1.4.5.min.js"></script>

    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">

    <link rel="stylesheet" href="../css/custom.css"/>

    <style>
        .card {
            background: #FFF;
            border: 1px solid #AAA;
            box-shadow: 0 2px 3px 0 #AAA;
            padding: 0;
            /*margin-right: 7.5px;*/
            margin-bottom: 15px;
            /*margin-left: 7.5px;*/
            overflow: hidden;
            border-radius: 3px;
            height: 190px;
            width: 100%;
            font-weight: normal !important;
        }

        .card-image {
            width: 100%;
            height: 160px;
            padding: 0;
            margin: 0;
            background-position: center;
            background-repeat: no-repeat;
            position: relative;
            overflow: hidden;
        }

        .card-title {
            position: absolute;
            bottom: 0;
            color: black;
            margin: 0;
            padding: 5px;
            border: none;
            padding-left: 8px !important;
        }

        .card-rating {
            bottom: 0;
            color: black;
            margin: 0;
            padding: 5px;
            border: none;
            float: right !important;
            padding-right: 8px !important;
        }

        .custom-star {
            height: 23px;
            width: 23px;
        }
    </style>

</head>
<body>
<div data-role="page">
    <div class="top pl-3 pr-3 pb-2 fixed-top">
        <div data-role="header" class="mb-1 header">
            <button data-rel="back" class="ui-btn ui-btn-icon-left ui-icon-back custom-back" id="backBtn">Back</button>
            <h1>
                <img src="../assets/logos/MainLight.png" class="img-fluid" alt="Logo.png">
            </h1>
            <button class="ui-btn-right ui-btn ui-btn-icon-notext ui-icon-notification">Notification</button>
        </div>
        <div class="row justify-content-center">
            <div class="col-sm-10">
                <a href="#popupBasicLocation" data-rel="popup" data-transition="pop" id="selectLocation"
                   class="ui-btn ui-shadow ui-corner-all ui-btn-icon-left ui-icon-location custom-search-bar">Select
                    Your
                    Location</a>
            </div>
        </div>
        <div class="row mt-n2"> <!--first hr line-->
            <div class="col">
                <hr>
            </div>
        </div>
        <div class="row mt-n3"> <!--search by name and filtering row-->
            <div class="col-10 mr-auto pt-2">
                <input data-type="search" id="searchForCollapsibleSet" name="search" value=""
                       placeholder="Search Restaurant by Name"/>
            </div>
            <div class="col-auto">
                <a href="#popupBasic" data-rel="popup" data-transition="pop" id="merchantFilter"
                   class="ui-btn ui-corner-all ui-icon-filter ui-btn-icon-notext custom-filter-button">Filter</a>
            </div>
        </div>
        <div class="row mt-n3">  <!--second hr line-->
            <div class="col">
                <hr>
            </div>
        </div>
        <div class="row mt-n3">
            <div class="col"><span style="color: #F19B55; font-weight: bold">Search</span></div>
        </div>

        <!--Location Modal-->
        <div data-role="popup" id="popupBasicLocation" class="custom-location" data-position-to="window"
             data-overlay-theme="a" data-transition="pop">
            <div class="row mb-2">
                <div class="col-8">
                </div>
                <div class="col-4 custom-close-button">
                    <a href="#" data-rel="back" data-role="button" data-transition="pop"
                       class="ui-btn ui-icon-delete ui-btn-icon-notext ui-corner-all m-0">No text</a>
                </div>
            </div>
            <form>
                <div class="ui-input-search ui-body-inherit ui-corner-all ui-shadow-inset ui-input-has-clear">
                    <input data-type="search" data-enhanced="true" data-inset="false" id="pre-rendered-example-input"
                           placeholder="Search by locations..." value="">
                </div>
                <div data-role="controlgroup" data-enhanced="true" data-filter="true" data-filter-reveal="true"
                     data-input="#pre-rendered-example-input"
                     class="ui-controlgroup ui-controlgroup-vertical ui-corner-all">
                    <div class="ui-controlgroup-controls">
                        <a href="#"
                           class="ui-btn ui-corner-all ui-shadow ui-shadow ui-screen-hidden ui-btn-icon-left
                           ui-icon-location location" data-filtertext = "Colombo 10">Colombo
                            10</a>
                        <a href="#"
                           class="ui-btn ui-corner-all ui-shadow ui-first-child ui-shadow ui-last-child ui-btn-icon-left
                           ui-icon-locationlocation" data-filtertext = "Colombo 11">Colombo 11</a>
                        <a href="#"
                           class="ui-btn ui-corner-all ui-shadow ui-shadow ui-screen-hidden ui-btn-icon-left
                           ui-icon-location location" data-filtertext = "Maradhana">Maradana</a>
                    </div>
                </div>
            </form>
        </div>
        <!--Filters Modal-->
        <div data-role="popup" id="popupBasic" class="custom-filter" data-position-to="window" data-overlay-theme="a"
             data-transition="pop">
            <div class="row mb-2">
                <div class="col-8">
                    <label><strong>Categories </strong> </label>
                </div>
                <div class="col-4 custom-close-button">
                    <a href="#" data-rel="back" data-role="button" data-transition="pop"
                       class="ui-btn ui-icon-delete ui-btn-icon-notext ui-corner-all m-0">No text</a>
                </div>
            </div>

            <form>
                <div class="row mb-3">
                    <div class="col-6">
                        <div class="row">
                            <div class="col-4">
                                <label for="flip-1">Pizza</label>
                            </div>
                            <div class="col-8 custom-switch">
                                <select name="flip-1" id="flip-1" data-role="slider" style="width: 4.0em;">
                                    <option value="off"></option>
                                    <option value="on"></option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="row">
                            <div class="col-4">
                                <label for="flip-2">Salad</label>
                            </div>
                            <div class="col-8 custom-switch">
                                <select name="flip-2" id="flip-2" data-role="slider" style="width: 4.0em;">
                                    <option value="off"></option>
                                    <option value="on"></option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="row mb-3">
                    <div class="col-6">
                        <div class="row">
                            <div class="col-4">
                                <label for="flip-3">Bakery</label>
                            </div>
                            <div class="col-8 custom-switch">
                                <select name="flip-3" id="flip-3" data-role="slider" style="width: 4.0em;">
                                    <option value="off"></option>
                                    <option value="on"></option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="row">
                            <div class="col-4">
                                <label for="flip-4">Chinese</label>
                            </div>
                            <div class="col-8 custom-switch">
                                <select name="flip-4" id="flip-4" data-role="slider" style="width: 4.0em;">
                                    <option value="off"></option>
                                    <option value="on"></option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
            </form>
            <!--<form>
                <div data-role="rangeslider">
                    <label for="range-1a" class="mb-3"><strong>Price Range (LKR)</strong></label>
                    <input type="range" name="range-1a" id="range-1a" min="0" max="100" value="40">
                    <label for="range-1b">Rangeslider:</label>
                    <input type="range" name="range-1b" id="range-1b" min="0" max="100" value="80">
                </div>
            </form>-->

            <div class="col-12 mb-3 p-0">
                <div class="row col-12 m-0 p-0 mt-3">
                    <div class="col-6 m-0 p-0">
                        <a href="#" data-rel="back" data-role="button" class="border  rounded-pill mr-1 text-white" style="background-color:#282F33;color: white; text-decoration: none; font-size:14px;font-weight: normal">Cancel</a>

                    </div>
                    <div class="col-6 m-0 p-0">
                        <button id="filterApply" class="border rounded-pill ml-1 text-white" style="background-color:#EC7A23;color: white; font-size:14px;text-decoration: none; font-weight: normal">Apply</button>

                    </div>
                </div>
            </div>
            <!--<div class="row mb-3 mt-3">-->
                <!--<div class="col-6">-->
                    <!--<a href="#" data-rel="back" data-role="button" class="ui-btn">Cancel</a>-->
                <!--</div>-->
                <!--<div class="col-6">-->
                    <!--<button id="filterApply" class="ui-btn">Apply</button>-->
                <!--</div>-->
            <!--</div>-->
        </div>

    </div>

    <div class="main"> <!--content area starts from here-->
        <div class="mr-2 ml-2 mt-n4">
            <!--Merchant Cards-->
            <div class="row" data-role="collapsible-set" data-filter="true" data-inset="true"
                 id="collapsiblesetForFilter" data-input="#searchForCollapsibleSet">
                <!--merchants cards will be appeared here.-->
            </div>
        </div>

    </div>

    <!--sig-in confirmation modal-->
    <div data-role="popup" id="signin-required-modal" style=" width: 300px !important;" data-position-to="window"
         data-overlay-theme="a"
         data-transition="pop">
        <div class="row mt-3">
            <div class="col-8">
            </div>
            <div class="col-4 custom-close-button" style="padding-right: 25px;">
                <a href="#" data-rel="back" data-role="button" data-transition="pop"
                   class="ui-btn ui-icon-delete ui-btn-icon-notext ui-corner-all m-0">No text</a>
            </div>
        </div>
        <div style="text-align: -webkit-center;">

        </div>

        <div class="container">
            <div class="row mb-2" style="">
                <div class="col-12 text-center" style="font-size: 14px; font-weight: bold;">
                    You need to login to buy something!
                    Please click proceed to login.
                </div>
                <div class="col-12 mb-3">
                    <div class="row col-12 m-0 p-0 mt-3">
                        <div class="col-6 m-0 p-0">
                            <button class="border  rounded-pill mr-1 text-white" id="btnCancel" style="background-color:#282F33;color: white; text-decoration: none; font-size:14px;font-weight: normal">Cancel</button>

                        </div>
                        <div class="col-6 m-0 p-0">
                            <button class="border rounded-pill ml-1 text-white" style="background-color:#EC7A23;color: white; font-size:14px;text-decoration: none; font-weight: normal"
                                    onclick='window.location.href="../welcome_screens/SignIn.html"'>Proceed</button>

                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!--Cart Modal & Delivery Modal
        <div id="cartModal"></div>-->
    <div id="cartModal"></div>

     <!--side drawer for profile section-->
    <div data-role="panel" data-position="right" data-display="overlay" data-theme="a" id="side-drawer"
         style="z-index: 1400">
                
        <div><img src="../assets/logos/MainLight.png" class="side-drawer-logo"></div>
        <ul data-role="listview">
            <li data-icon="false"><a onclick='window.location.href="../profile/MyAccount.html"' class="side-drawer-option">My Account</a></li>
            <li data-icon="false"><a  onclick='window.location.href="../profile/Help-about.html"' class="side-drawer-option">Help/About</a></li>
            <li data-icon="false"><a  onclick='window.location.href="../profile/Favorites.html"' class="side-drawer-option"> Favorites</a></li>
            <li data-icon="false"><a  onclick='window.location.href="../profile/Acheivements.html"' class="side-drawer-option">Acheivements</a></li>
            <li data-icon="false"><a  id="profile_logout" class="side-drawer-option">Logout</a></li>
        </ul>
            
    </div><!-- /panel -->

    <!--Footer-->
    <div class="footer">
        <div class="row justify-content-between">
            <div class="col d-flex justify-content-left ml-3 p-3">
                <img src="../assets/logos/AltDark.png" class="img-fluid" alt="logo">
            </div>
            <div class="col mr-3 p-3">
                <div class="row">
                    <div class="col font1">Privacy Policy Terms of Use</div>
                    <div class="w-100"></div>
                    <div class="col font2">© 2020 HOMEAL. All rights reserved</div>
                </div>
            </div>
        </div>
    </div>

    <div data-role="footer" class="fixed-bottom">
        <nav data-role="navbar">
            <ul>
                <li><a id="nav_bar_home" class="ui-btn ui-icon-home ui-btn-icon-top ui-btn-active ui-state-persist">Home</a></li>
                <li><a id="nav_bar_orders" class="ui-btn ui-icon-orders ui-btn-icon-top">Orders</a></li>
                <li><a id="nav_bar_cart" class="ui-btn ui-icon-cart ui-btn-icon-top">Cart</a></li>
                <li><a id="nav_bar_profile" class="ui-btn ui-icon-profile ui-btn-icon-top">Profile</a></li>
            </ul>
        </nav>
    </div>
</div>
</body>

<script src="../js/common.js"></script>
<script>

    $.mobile.ajaxEnabled = false;
    console.log('ajax disabled.');
    let merchantJsonArray;
    $(document).ready(function () {
        merchantJsonArray = JSON.parse(sessionStorage.getItem('merchants'));
        let user = JSON.parse(sessionStorage.getItem('user'));
        let merchants = "";
        let location = '';
        if (user) {
            location = user['location'];
        } else {
            location = sessionStorage.getItem('location');
        }
        $.each(merchantJsonArray, function (i, merchant) {
           if (merchant['merchantLocation'].toLowerCase() === location.toLowerCase()) {
               let href = '/HOMEAL/welcome_screens/SignIn.html'
               if (user) {
                    href = "/HOMEAL/home/Merchant.html?merchant_id=" + merchant['merchant_id'];
               }
               merchants += `<div class="col-12 col-sm-6 col-md-4 pr-3 pl-3" data-filtertext="${merchant.filter_text}">
                            <a class="card" href="#" data-merchant_id="${merchant['merchant_id']}">
                                <div class="card-image">
                                    <img alt="home" src="${merchant.merchant_background_img_path}" style="width: 100%;"/>
                                </div>
                                <div class="ui-grid-a">
                                    <span class="card-title">${merchant.merchant_name}</span>
                                    <span class="row card-rating">  <img alt="home"
                                                                         src="../assets/icons/star_orange_18dp.png"
                                                                         class="custom-star"/>50+ Rating</span>
                                </div>
                            </a>
                        </div>`;
           }
        });
        $("#collapsiblesetForFilter").append(merchants);
    });

    $( "#backBtn" ).click(function() {
        window.history.back();
    });

    $(document).on('click', '.card', function() {
        let merchant_id = $(this).data('merchant_id');
        let user = sessionStorage.getItem('user');
        if (user) {
            window.location.href = "/HOMEAL/home/Merchant.html?merchant_id=" + merchant_id;
        } else {
            $('#signin-required-modal').popup('open');
        }
    });

    $('#btnCancel').click(function () {
        $('#signin-required-modal').popup('close');
    });

    // save the values of the filtering modal
    let filterValuesSet = new Set();

    $( "#flip-1" ).on( 'slidestop', function( event ) {
        if ($( "#flip-1" ).val() === 'on') {
            filterValuesSet.add('pizza');
        } else {
            filterValuesSet.delete('pizza');
        }
    });
    $( "#flip-2" ).on( 'slidestop', function( event ) {
        if ($( "#flip-2" ).val() === 'on') {
            filterValuesSet.add('salads');
        } else {
            filterValuesSet.delete('salads');
        }
    });
    $( "#flip-3" ).on( 'slidestop', function( event ) {
        if ($( "#flip-3" ).val() === 'on') {
            filterValuesSet.add('bakery');
        } else {
            filterValuesSet.delete('bakery');
        }
    });
    $( "#flip-4" ).on( 'slidestop', function( event ) {
        if ($( "#flip-4" ).val() === 'on') {
            filterValuesSet.add('chinese');
        } else {
            filterValuesSet.delete('chinese');
        }
    });

    $('#filterApply').click(function () {
        let isTemp = false;
        if (filterValuesSet.size === 0) {
            filterValuesSet.add('chinese').add('pizza').add('bakery').add('salads'); // add all available categories
            isTemp = true;
        }
        let collapsiblesetForFilter = $("#collapsiblesetForFilter")
        collapsiblesetForFilter.empty();
        let user = JSON.parse(sessionStorage.getItem('user'));
        let merchants = "";
        let location = '';
        if (user) {
            location = user['location'];
        } else {
            location = sessionStorage.getItem('location');
        }
        $.each(merchantJsonArray, function (i, merchant) {
            let merchant_category = merchant['merchant_category'].toLowerCase();
            if (!filterValuesSet.has(merchant_category)) {
                return true; // continue
            }
            if (merchant['merchantLocation'].toLowerCase() === location.toLowerCase()) {
                let href = '/HOMEAL/welcome_screens/SignIn.html'
                if (user) {
                    href = "/HOMEAL/home/Merchant.html?merchant_id=" + merchant['merchant_id'];
                }
                merchants += `<div class="col-12 col-sm-6 col-md-4 pr-3 pl-3" data-filtertext="${merchant.filter_text}">
                            <a class="card" href="${href}">
                                <div class="card-image">
                                    <img alt="home" src="${merchant.merchant_background_img_path}" style="width: 100%;"/>
                                </div>
                                <div class="ui-grid-a">
                                    <span class="card-title">${merchant.merchant_name}</span>
                                    <span class="row card-rating">  <img alt="home"
                                                                         src="../assets/icons/star_orange_18dp.png"
                                                                         class="custom-star"/>50+ Rating</span>
                                </div>
                            </a>
                        </div>`;
            }
        });
        if(merchants === '') {
            merchants = ' <div id="outer-div" ><div id="inner-div" style="font-weight: bold;font-variant: all-small-caps;position: absolute;top: 50%;left: 50%;transform: translate(-50%, -50%);">No merchants items <br>available to display for <br>selected location.</div></div>'
        }
        collapsiblesetForFilter.append(merchants);
        if (isTemp) {
            filterValuesSet.clear();
        }
        $('#popupBasic').popup('close');
    });

    $( "#home-nav-text" ).click(function() {
        let user = JSON.parse(sessionStorage.getItem('user'));
        console.log(user);
        if(!!user) {

        } else {
            window.location.href ='./Home.html'
        }
    });

    $( "#cartModal" ).load( "../common/Cart_N_Delivery_Modal.html" );

    /* ******************* Do not remove this part till 2021/01/13 *****************
    $(document).on('click', '.card', function () {
        let id = $(this).data('id');
        if (id) {
            console.log("id: ", id);
            $.mobile.ajaxEnabled = false;
            $.mobile.pageContainer.pagecontainer("change", '/HOMEAL/home/Merchant.html?merchant_id=' + id,
                {transition: "flow", changeHash: true, reload: true, })
        // $.mobile.pagecontainer( "load", '/HOMEAL/home/Merchant.html?merchant_id=' + id);
        //     $.mobile.navigate('/HOMEAL/home/Merchant.html?merchant_id=' + id);
           /!* $.mobile.changePage(
                window.location.href,
                {
                    allowSamePageTransition : true,
                    transition              : 'none',
                    showLoadMsg             : false,
                    reloadPage              : true
                }
            );*!/
        }
    });*/
</script>
<script src="../js/location.js"></script>

</html>
