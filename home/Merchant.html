<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Merchant</title>
    <link rel="icon" href="../assets/logos/Title.png"
          type="image/x-icon">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="http://code.jquery.com/mobile/1.4.5/jquery.mobile-1.4.5.min.css"/>
    <script src="http://code.jquery.com/jquery-1.11.1.min.js"></script>
    <script src="http://code.jquery.com/mobile/1.4.5/jquery.mobile-1.4.5.min.js"></script>

    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">

    <link rel="stylesheet" href="../css/custom.css"/>
</head>
<body>
<div data-role="page">
    <div class="top pl-3 pr-3 pb-2 fixed-top">
        <div data-role="header" class="mb-1 header">
            <button data-rel="back" class="ui-btn ui-btn-icon-left ui-icon-back custom-back" id="backBtn">Back</button>
            <h1>
                <img src="../assets/logos/MainLight.png" class="img-fluid" alt="Logo.png">
            </h1>
            <button class="ui-btn-right ui-btn ui-btn-icon-notext ui-icon-notification">Notification</button>
        </div>
        <div class="row justify-content-center">
            <div class="col-sm-10">
                <a href="#popupBasicLocation" data-rel="popup" data-transition="pop"
                   class="ui-btn ui-shadow ui-corner-all ui-btn-icon-left ui-icon-location custom-search-bar">Select
                    Your
                    Location</a>
            </div>
        </div>
       <!-- <div class="row mt-n2"> &lt;!&ndash;first hr line&ndash;&gt;
            <div class="col">
                <hr>
            </div>
        </div>-->
       <!-- <div class="row mt-n3"> &lt;!&ndash;search by name and filtering row&ndash;&gt;
            <div class="col-10 mr-auto pt-2">
                <input data-type="search" id="searchForCollapsibleSet" name="search" value=""
                       placeholder="Search Restaurant by Name"/>
            </div>
            <div class="col-auto">
                <a href="#popupBasic" data-rel="popup" data-transition="pop"
                   class="ui-btn ui-corner-all ui-icon-filter ui-btn-icon-notext custom-filter-button">Filter</a>
            </div>
        </div>-->
        <div class="row mt-n1">  <!--second hr line-->
            <div class="col">
                <hr>
            </div>
        </div>
        <div class="row mt-n1">
            <div class="col"><span id="search-nav-text"> Search </span> / <span style="color: #F19B55; font-weight: bold">Merchant</span></div>
        </div>

        <!--Location Modal-->
        <div data-role="popup" id="popupBasicLocation" class="custom-location" data-position-to="window"
             data-overlay-theme="a" data-transition="pop">
            <div class="row mb-2">
                <div class="col-8">
                </div>
                <div class="col-4 custom-close-button">
                    <a href="#" data-rel="back" data-role="button" data-transition="pop"
                       class="ui-btn ui-icon-delete ui-btn-icon-notext ui-corner-all m-0">No text</a>
                </div>
            </div>
            <form>
                <div class="ui-input-search ui-body-inherit ui-corner-all ui-shadow-inset ui-input-has-clear">
                    <input data-type="search" data-enhanced="true" data-inset="false" id="pre-rendered-example-input"
                           placeholder="Search by locations..." value="">
                </div>
                <div data-role="controlgroup" data-enhanced="true" data-filter="true" data-filter-reveal="true"
                     data-input="#pre-rendered-example-input"
                     class="ui-controlgroup ui-controlgroup-vertical ui-corner-all">
                    <div class="ui-controlgroup-controls">
                        <a href="#"
                           class="ui-btn ui-corner-all ui-shadow ui-shadow ui-screen-hidden ui-btn-icon-left ui-icon-location">Colombo
                            10</a>
                        <a href="#"
                           class="ui-btn ui-corner-all ui-shadow ui-first-child ui-shadow ui-last-child ui-btn-icon-left ui-icon-location">Colombo
                            11</a>
                        <a href="#"
                           class="ui-btn ui-corner-all ui-shadow ui-shadow ui-screen-hidden ui-btn-icon-left ui-icon-location">Maradana</a>
                    </div>
                </div>
            </form>
        </div>
        <!--Filters Modal-->
        <div data-role="popup" id="popupBasic" class="custom-filter" data-position-to="window" data-overlay-theme="a"
             data-transition="pop">
            <div class="row mb-2">
                <div class="col-8">
                    <label><strong>Categories </strong> </label>
                </div>
                <div class="col-4 custom-close-button">
                    <a href="#" data-rel="back" data-role="button" data-transition="pop"
                       class="ui-btn ui-icon-delete ui-btn-icon-notext ui-corner-all m-0">No text</a>
                </div>
            </div>

            <form>
                <div class="row mb-3">
                    <div class="col-6">
                        <div class="row">
                            <div class="col-4">
                                <label for="flip-1">Pizza</label>
                            </div>
                            <div class="col-8 custom-switch">
                                <select name="flip-1" id="flip-1" data-role="slider" style="width: 4.0em;">
                                    <option value="off"></option>
                                    <option value="on"></option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="row">
                            <div class="col-4">
                                <label for="flip-2">Noodles</label>
                            </div>
                            <div class="col-8 custom-switch">
                                <select name="flip-2" id="flip-2" data-role="slider" style="width: 4.0em;">
                                    <option value="off"></option>
                                    <option value="on"></option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="row mb-3">
                    <div class="col-6">
                        <div class="row">
                            <div class="col-4">
                                <label for="flip-3">Bakery</label>
                            </div>
                            <div class="col-8 custom-switch">
                                <select name="flip-3" id="flip-3" data-role="slider" style="width: 4.0em;">
                                    <option value="off"></option>
                                    <option value="on"></option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="row">
                            <div class="col-4">
                                <label for="flip-4">Chinese</label>
                            </div>
                            <div class="col-8 custom-switch">
                                <select name="flip-4" id="flip-4" data-role="slider" style="width: 4.0em;">
                                    <option value="off"></option>
                                    <option value="on"></option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
            </form>
            <form>
                <div data-role="rangeslider">
                    <label for="range-1a" class="mb-3"><strong>Price Range (LKR)</strong></label>
                    <input type="range" name="range-1a" id="range-1a" min="0" max="100" value="40">
                    <label for="range-1b">Rangeslider:</label>
                    <input type="range" name="range-1b" id="range-1b" min="0" max="100" value="80">
                </div>
            </form>

            <div class="row mb-3 mt-3">
                <div class="col-6">
                    <a href="#" data-rel="back" data-role="button" class="ui-btn">Cancel</a>
                </div>
                <div class="col-6">
                    <button class="ui-btn">Apply</button>
                </div>
            </div>
        </div>

    </div>

    <div class="main" style="margin-top: 9rem;"> <!--content area starts from here-->
        <div class="mr-2 ml-2">
            <!--Merchant Content-->
            <div class="row" data-role="collapsible-set" data-filter="true" data-inset="true"
                 id="collapsiblesetForFilter" data-input="#searchForCollapsibleSet">

            </div>
        </div>

        <!--Product Modal-->
        <div data-role="popup" data-history="false" id="productModel" class="container product-modal" data-position-to="window"
             data-overlay-theme="a" data-transition="pop" style="    border-top-left-radius: 10px ;
    border-top-right-radius: 10px ;">
                <div class="row" id="prd-modal-header">
                    <div class="col-8 mt-3">
                        <label><strong id="prdModal-productName">Chicken Pizza</strong></label>
                    </div>
                    <div class="col-4 mt-1" style="text-align: -webkit-right !important;">
                        <a href="#" data-rel="back" data-role="button" data-transition="pop"
                           class="ui-btn ui-icon-delete ui-btn-icon-notext ui-corner-all m-0">No text</a>
                    </div>
                    <br>
                    <div class="col-12">
                        <p id="prdModal-productDescription">The consumption of food is normally enjoyable to humans. It contains protein, fat, carbohydrates,
                            vitamins, water and minerals</p>
                    </div>
                    <div class="row w-100">
                       <div class="col-6 pl-4">
                           <div class="prd-modal-discount-card" id="prdModal-itmDiscount">
                            Save Upto 10%
                         </div>
                       </div>
                        <div class="col-6 mb-1" style="text-align: -webkit-right;">
                            <img id="productModal_fav" src="../assets/icons/favorite_border.png"
                                 style="border-radius: 10px;  height:30px;width:30px;!important; object-fit: cover;"
                                 alt="Card image">
                          </div>
                    </div>
                </div>

                <form id="radioBtn">
                    <label class="mt-3"><strong>Size</strong></label>
                    <hr class="m-0">
                    <div class="row mb-2" id="test">
                        <div class="col-12">
                            <label  for="radio-small" class="ui-radio-btn">Small<span
                                    class="pull-right" id="small">LKR 1300.00</span></label><input type="radio" name="size"
                                                                                        id="radio-small" value="small" checked>
                            <label for="radio-medium" class="ui-radio-btn">Medium<span
                                    class="pull-right" id="medium">LKR 1300.00</span></label><input type="radio" name="size"
                                                                                        id="radio-medium" value="medium">
                            <label for="radio-large" class="ui-radio-btn">Large<span
                                    class="pull-right" id="large">LKR 1300.00</span></label><input type="radio" name="size"
                                                                                        id="radio-large" value="large"></div>
                    </div>
                </form>

                <div>
                    <div class="row m-1">
                        <label class="mb-2"><strong>Reviews</strong></label></div>

                    <div class="row m-1" id="prdModal-reviews">
                        <div class="col-4"></div>
                        <div class="col-8">

                            <div class="row">
                                <div class="col-7 p-0 m-0">
                                    <span class="fa fa-star prd-modal-start-checked"></span>
                                    <span class="fa fa-star prd-modal-start-checked"></span>
                                    <span class="fa fa-star prd-modal-start-checked"></span>
                                    <span class="fa fa-star"></span>
                                    <span class="fa fa-star"></span>

                                </div>
                                <div class="col-5 p-0 m-0 text-right">2020/11/10</div>

                            </div>
                            <div class="row">John Doe</div>
                            <div class="row">
                                <p>This is a very good product</p>
                            </div>

                        </div>
                    </div>
                </div>

                <div style="margin: 10px">
                    <div style="background-color: #AAAAAA;height: 1px;opacity:0.5"></div>
                    <div class="row">
                        <div class="col-3 p-0" style="display:inline-flex;">
                            <button id="minus"  class="prd-modal-qty-btn">-</button>
                            <input type="number" id="number" value="1" disabled="disabled" class="prd-modal-qty-btn text-center"/>
                            <button id="plus" class="prd-modal-qty-btn" >+</button>

                        </div>
                        <div class="col-6 p-0 m-0">
                            <button id="addToCart" class="prd-modal-ctrl-btn"><span class="pull-left">Add to Cart</span>
                                <span id="addToCartValue" class="pull-right">1500.00</span>
                            </button>
                        </div>
                        <div class="col-3 p-0 m-0">
                            <button id="buyNow" class="prd-modal-ctrl-btn">Buy Now</button>
                        </div>
                    </div>
                </div>
        </div>

        <!--Cart Modal & Delivery Modal-->
        <div id="cartModal"></div>

    </div>

    <!--Footer-->
    <div class="footer">
        <div class="row justify-content-between">
            <div class="col d-flex justify-content-left ml-3 p-3">
                <img src="../assets/logos/AltDark.png" class="img-fluid" alt="logo">
            </div>
            <div class="col mr-3 p-3">
                <div class="row">
                    <div class="col font1">Privacy Policy Terms of Use</div>
                    <div class="w-100"></div>
                    <div class="col font2">Â© 2020 HOMEAL. All rights reserved</div>
                </div>
            </div>
        </div>
    </div>

    <div data-role="footer" id="bottom-nav" class="fixed-bottom">
        <nav data-role="navbar">
            <ul>
                <li><a href="#" class="ui-btn ui-icon-home ui-btn-icon-top ui-btn-active ui-state-persist">Home</a></li>
                <li><a href="#" class="ui-btn ui-icon-orders ui-btn-icon-top">Orders</a></li>
                <!--<li><a href="#cart_popup" data-rel="popup" data-transition="pop"
                       class="ui-btn ui-icon-cart ui-btn-icon-top">Cart</a></li>-->
                <li><a href="#" id="nav_bar_cart" class="ui-btn ui-icon-cart ui-btn-icon-top">Cart</a></li>
                <!--<li><a href="#delivery_details" data-rel="popup" data-transition="pop"
                       class="ui-btn ui-icon-profile ui-btn-icon-top">Profile</a></li>-->
                <li><a href="/HOMEAL/profile/Favorites.html" data-rel="popup" data-transition="pop"
                       class="ui-btn ui-icon-profile ui-btn-icon-top">Profile</a></li>
            </ul>
        </nav>
    </div>
</div>
</body>

<script>

    let merchant_id = '';
    let selected_product_id = '';
    let merchant_json;
    let productsArr;
    let user;
    let openDelivery = false;

    $.mobile.ajaxEnabled = false;
    $(document).ready(function () {
        let retrievedProductArr = sessionStorage.getItem('products');
        productsArr = JSON.parse(retrievedProductArr); /*scope down in further steps*/
        let searchParams = new URLSearchParams(window.location.search);
        user = JSON.parse(sessionStorage.getItem('user'));
        if (searchParams.has('merchant_id')) {
            merchant_id = searchParams.get('merchant_id');
            console.log("Merchant id: ", merchant_id);
        } else {
            console.log("merchant id could not extract from the url.");
        }
        let merchantJsonArray = JSON.parse(sessionStorage.getItem('merchants'));
        $.each(merchantJsonArray, function (i, merchant) {
            if (merchant_id === merchant.merchant_id) {
                merchant_json = merchant;
                console.log('merchant_json: ', merchant_json);
                let container =
                    `
             <div class="container p-0" style=" max-width: 100% !important;">
                <div id="merchantBanner" id="prd-1-normal" style="height: 150px">
                    <div class="container overlay-text mt-2 pt-2 pb-2">
                        <div class="row col-12 m-0 p-0">
                            <div class="col-12 m-0 p-0 pt-2" style="text-align: -webkit-center;">
                                 <img alt="home" src="${merchant_json.merchant_logo_img_path}" style="width: 50px;height: 50px; "/>
                            </div>
                        </div>
                        <div class="row m-0 mb-3">
                            <div class="col-12 m-0 p-0" style="text-align: -webkit-center;">
                                <span class="pb-3 text-white" style="font-size: 16px">${merchant_json.merchant_name}</span>
                            </div>
                        </div>
                        <div class="row col-12 m-0 p-0">
                            <div class="col-6 m-0 p-0">
                                         <span class="ratingText text-white"><img alt="home" src="../assets/icons/star_orange_18dp.png"
                                                                    class="custom-star"/>50+ Rating</span>
                            </div>
                            <div class="col-6 m-0 p-0" style="text-align: end;">
                               <span class="pr-3 deliveryTimeContainer deliveryTimeText">30-45 Mins</span>
                            </div>
                          </div>
                     </div>
                  </div>
            </div>

                            <div class="container" style=" max-width: 100% !important;">
                                <div class="scrollmenu">
                                    <a href="#news">Sri Lankan</a>
                                    <a href="#contact">Asian</a>
                                    <a href="#about">Indian</a>
                                    <a href="#support">Pasta</a>
                                    <a href="#blog">Noodles</a>
                                    <a href="#tools">Pizza</a>
                                    <a href="#base">Rice</a>
                                    <a href="#custom">Salads</a>
                                </div>

                            </div>`
                $("#collapsiblesetForFilter").append(container);
                // binding css to the merchantBanner
                $("#merchantBanner").css({
                    "background": `linear-gradient(
                    rgba(0, 0, 0, 0.45),
                    rgba(0, 0, 0, 0.45)
            ), url(${merchant_json.merchant_background_img_path})`,
                    "background-size": "cover",
                    "background-position": "center !important",
                    "border-radius": "10px"
                })

                // loading products
                let products = '<div class="row mt-4 ml-2 mr-2">';
                $.each(productsArr, function (i, merchant) {
                    if (merchant_id === merchant.merchant_id) {
                        productsArr = merchant.products;
                        console.log('productsArr: ', productsArr);
                        productsArr.forEach(function (product) {
                            products +=
                                `
                            <div class="col-6 col-sm-3 col-md-3" data-filtertext="${product.filter_text}">
                                <div class="product-card" data-pid=${product.product_id}>
                                    <div class="product-card-image">
                                        <img alt="home" src="${product.product_img_path}" style="width: 100%;"/>

                            `;
                            let discount = product.discount;
                            discount = Number(discount);
                            if (Number.isNaN(discount)) {
                                discount = 0;
                            }
                            if (discount > 0) {
                                products += `
                                        <div class="bottom-right-saving-tag mr-3">
                                            <div class="deliveryTimeContainer pr-3 savingText">Save up to ${discount}%</div>
                                        </div>
                            `;
                            }
                            products += `
                              </div>
                                    <div class="col pl-2 pb-1">
                                        <div class="row">
                                            <div class="col-8 product-name">
                                            ${product['product_name']}
                                            </div>
                                            `;
                            let existingItem = user['favorites_list'].find(x =>
                                x['product_id'] === product['product_id'] && x['merchant_id'] === merchant_id);
                            if (existingItem) {
                                products += `<div class="col-4 favorite_icon" data-pid=${product['product_id']}
                                              data-fav="1" style="padding-right: 5px;text-align: -webkit-right;">
                                             <img src="../assets/icons/favorite.png"
                                         style="border-radius: 10px;  height: 20px;width:20px;!important; object-fit: cover;"
                                         alt="Card image">
                                            </div>`
                            } else {
                                products += `<div class="col-4 favorite_icon" data-pid=${product['product_id']}
                                              data-fav="0" style="padding-right: 5px;text-align: -webkit-right;">
                                             <img src="../assets/icons/favorite_border.png"
                                         style="border-radius: 10px;  height: 20px;width:20px;!important; object-fit: cover;"
                                         alt="Card image">
                                            </div>`;
                            }

                             products +=`</div>
                                        <div class="row-12 product-price">LKR ${product.variants[0].price}.00</div>
                                    </div>

                                </div>
                              </div>
                        `
                        });
                        return false; /*to break from the loop*/
                    }
                });
                products += '</div>'
                $("#collapsiblesetForFilter").append(products);
                return false; /*to break from the loop*/
            }
        });


        $('.ui-radio-btn').removeClass('ui-btn');
        console.log("cc"); // for the model/popup
    });

    $( "#backBtn" ).click(function() {
        window.history.back();
    });

    $('#plus').unbind('click').bind('click', function () {
        let value = $('#number').val();
        value++;
        $('#number').val(value);
        changePrice();
    });

    $('#minus').unbind('click').bind('click', function () {
        let value = $('#number').val();
        if (!(value <= 1)) {
            value--;
            $('#number').val(value);
            changePrice();
        }
    });

    // Add remove favourite items
    $(document).on('click', '.favorite_icon', function () {
        let pid = $(this).data('pid');
        let product = getProduct(pid);
        let isFavourite = $(this).data('fav');
        if (isFavourite === 1) {
            $(this).data('fav', 0); // set as not favorite
            user['favorites_list'] = $.grep(user['favorites_list'], function(item){
                let id = item['product_id'] + item['merchant_id'];
                return id !== pid + merchant_id;
            });
            $(this).children('img').attr('src', '../assets/icons/favorite_border.png');
        } else {
            $(this).data('fav', 1);
            let item = `
                    {
                        "product_id": "${product['product_id']}",
                        "merchant_id": "${merchant_id}",
                        "product_name": "${product['product_name']}",
                        "merchant_name": "${merchant_json['merchant_name']}",
                        "location": "${user['location']}",
                        "merchant_bg": "${merchant_json['merchant_background_img_path']}",
                        "merchant_logo": "${merchant_json['merchant_logo_img_path']}"
                    }`
            user['favorites_list'].push(JSON.parse(item));
            $(this).children('img').attr('src', '../assets/icons/favorite.png');
        }
        sessionStorage.setItem('user', JSON.stringify(user));
        return false; // to disable outer div being fired (Prevent Event Propagation).
    });

    // Loading product modal
    $(document).on('click', '.product-card', function() {
        selected_product_id = $(this).data('pid');
        console.log(selected_product_id);
        let product = getProduct(selected_product_id);
        //set header image;
        $('#prd-modal-header').css('background-image', ' linear-gradient(\n' +
            '            rgba(0, 0, 0, 0.45),\n' +
            '            rgba(0, 0, 0, 0.45)\n' +
            '    ), url(' + product['product_img_path'] + ')');
        let productModel = $("#productModel");
        $("#prdModal-productName").text(product['product_name']);
        $("#prdModal-productDescription").text(product['product_description']);
        let existingItem = user['favorites_list'].find(x =>  // find if selected item is existing in favorite list
            x['product_id'] === product['product_id'] && x['merchant_id'] === merchant_id);
        if (existingItem) {
            $("#productModal_fav").attr('src', '../assets/icons/favorite.png');
        } else {
            $("#productModal_fav").attr('src', '../assets/icons/favorite_border.png');
        }

        let discount = product.discount;
        discount = Number(discount);
        if (Number.isNaN(discount)) {
            discount = 0;
        }
        if (discount === 0) {
            $("#prdModal-itmDiscount").hide();
        } else {
            $("#prdModal-itmDiscount").show();
        }
        $("#small").text('LKR ' + product.variants[0].price.toFixed(2));
        $("#medium").text('LKR ' + product.variants[1].price.toFixed(2));
        $("#large").text('LKR ' + product.variants[2].price.toFixed(2));

        let reviews = '';
        let prdReviews = product.reviews;
        prdReviews.forEach(function (review) {
            reviews += `
            <div class="col-4">
               <img id="user_image" src="../assets/otherImages/Men-Profile-Image.png"
                                 style="width: 60px; height: 60px;border-radius: 50px;"
                                 alt="logo" />
</div>
                        <div class="col-8">

                            <div class="row">
                                <div class="col-7 p-0 m-0">`;
            switch (review.rating) {
                case '1': {
                    reviews += `<span class="fa fa-star prd-modal-start-checked"></span>
                            <span class="fa fa-star"></span>
                            <span class="fa fa-star"></span>
                            <span class="fa fa-star"></span>
                            <span class="fa fa-star"></span>`;
                    break;
                }
                case '2': {
                    reviews += `<span class="fa fa-star prd-modal-start-checked"></span>
                            <span class="fa fa-star prd-modal-start-checked"></span>
                            <span class="fa fa-star"></span>
                            <span class="fa fa-star"></span>
                            <span class="fa fa-star"></span>`;
                    break;
                }
                case '3': {
                    reviews += `<span class="fa fa-star prd-modal-start-checked"></span>
                            <span class="fa fa-star prd-modal-start-checked"></span>
                            <span class="fa fa-star prd-modal-start-checked"></span>
                            <span class="fa fa-star"></span>
                            <span class="fa fa-star"></span>`;
                    break;
                }
                case '4': {
                    reviews += `<span class="fa fa-star prd-modal-start-checked"></span>
                            <span class="fa fa-star prd-modal-start-checked"></span>
                            <span class="fa fa-star prd-modal-start-checked"></span>
                            <span class="fa fa-star prd-modal-start-checked"></span>
                            <span class="fa fa-star"></span>`;
                    break;
                }
                case '5': {
                    reviews += `<span class="fa fa-star prd-modal-start-checked"></span>
                            <span class="fa fa-star prd-modal-start-checked"></span>
                            <span class="fa fa-star prd-modal-start-checked"></span>
                            <span class="fa fa-star prd-modal-start-checked"></span>
                            <span class="fa fa-star prd-modal-start-checked"></span>`;
                    break;
                }
            }
            reviews +=
                               `</div>
                                <div class="col-5 p-0 m-0 text-right">${review.date}</div>

                            </div>
                            <div class="row">${review.user_name}</div>
                            <div class="row">
                                <p>${review.review_content}</p>
                            </div>
                        </div>
            `;
        })
        $("#prdModal-reviews").html(reviews);
        changePrice();
        productModel.popup( "open" );
    });

    function getProduct(pid) {
        let value = null;
        productsArr.forEach(function (product) {
            if (product.product_id === pid) {
                value =  product;
                return true;
            }
        });
        return value;
    }

    $( "#addToCart" ).click(function() {
        sessionStorage.setItem('isBuyNow', '0');
        let product = getProduct(selected_product_id);
        let productName = product.product_name;
        let type = $('input[name=size]:checked', '#radioBtn').val();
        let qty =  $('#number').val();
        let variant = '';
        let price = 0;
        switch (type) {
            case "small": {
                price = product.variants[0].price;
                variant = 'Small';
                break;
            }
            case "medium": {
                price = product.variants[1].price;
                variant = 'Medium';
                break;
            }
            case "large": {
                price = product.variants[2].price;
                variant = 'Large';
                break;
            }
        }
        let item = `
        {
            "product_id": "${selected_product_id}",
            "product_name": "${productName}",
            "variant": "${variant}",
            "price": ${price},
            "qty": ${qty}
        }
        `;
        let cartItems = sessionStorage.getItem('cartItems');
        if (cartItems == null) {
            let jsonArr =
                `
                {
                    "merchant_id": "${merchant_id}",
                    "items":[${item}]
                }
                `;
            sessionStorage.setItem('cartItems', jsonArr);
            console.log('cart item initialized.');
        } else {
            cartItems = sessionStorage.getItem('cartItems');
            let itemsArr = JSON.parse(cartItems);
            if (itemsArr['merchant_id'] !== merchant_id) {
                let response = confirm('Items from another merchant are available in the cart. This action will remove those ' +
                    'items from the cart. Do you wish to continue?');
                if (response) {
                    let jsonArr =
                        `
                {
                    "merchant_id": "${merchant_id}",
                    "items":[${item}]
                }
                `;
                    sessionStorage.setItem('cartItems', jsonArr);
                    console.log('cart item initialized.');
                }
            } else {
                let existingItem = itemsArr['items'].find(x => x['product_id'] === selected_product_id
                    & x['price'] === price);
                if (existingItem) {
                    existingItem.qty = parseInt(qty);
                } else {
                    itemsArr['items'].push(JSON.parse(item));
                }
                sessionStorage.setItem('cartItems', JSON.stringify(itemsArr));
                console.log('cart items updated');
                console.log(itemsArr);
            }
        }
        $( "#nav_bar_cart" ).removeClass('ui-icon-cart');
        $( "#nav_bar_cart" ).addClass('ui-icon-cart-with-items');
    });

    $( "#buyNow" ).click(function() {
        sessionStorage.setItem('isBuyNow', '1');
        let product = getProduct(selected_product_id);
        let productName = product.product_name;
        let type = $('input[name=size]:checked', '#radioBtn').val();
        let qty =  $('#number').val();
        let price = 0;
        switch (type) {
            case "small": {
                price = product.variants[0].price;
                break;
            }
            case "medium": {
                price = product.variants[1].price;
                break;
            }
            case "large": {
                price = product.variants[2].price;
                break;
            }
        }
        let item = `
        {
            "merchant_id": "${merchant_id}",
            "product_id": "${selected_product_id}",
            "product_name": "${productName}",
            "price": ${price},
            "qty": ${qty}
        }
        `;
        sessionStorage.setItem('buyNowItem', item);
        console.log(JSON.parse(sessionStorage.getItem('buyNowItem')).price);
        // window.location.href="/HOMEAL/home/Checkout.html";
        openDelivery = true;
        popupDeliveryModalInBuyNow();
    });

    function popupDeliveryModalInBuyNow() {
        let productModal = $("#productModel");
        productModal.popup('close');
        productModal.on("popupafterclose", function () {
            //any action you want like opening another popup
            if (openDelivery) {
                let deliveryModal = $("#delivery_details");
                $("#radio_1").prop("checked", true);
                deliveryModal.popup("open");
                deliveryModal.on("popupafterclose", function () {
                    openDelivery = false;
                });
            }
        });
    }

    $("input[name='size']").change(function(e) {
        changePrice();
    });

    function changePrice() {
        let product = getProduct(selected_product_id);
        let type = $('input[name=size]:checked', '#radioBtn').val();
        let qty =  $('#number').val();
        let price = 0;
        switch (type) {
            case "small": {
                price = product.variants[0].price;
                break;
            }
            case "medium": {
                price = product.variants[1].price;
                break;
            }
            case "large": {
                price = product.variants[2].price;
                break;
            }
        }
        price = Number(price);
        qty = parseInt(qty);
        let val = (price * qty).toFixed(2);
        $('#addToCartValue').text(val);
    }

    $( "#cartModal" ).load( "../common/Cart_N_Delivery_Modal.html" );

    $( "#home-nav-text" ).click(function() {
        let user = JSON.parse(sessionStorage.getItem('user'));
        if(!!user) {

        } else {
            window.location.href ='./Home.html'
        }
    });
    $( "#search-nav-text" ).click(function() {
        window.location.href ='./Search.html'
    });
</script>

</html>
