<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>My Favourites</title>
    <link rel="icon" href="../assets/logos/Title.png"
          type="image/x-icon">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="http://code.jquery.com/mobile/1.4.5/jquery.mobile-1.4.5.min.css"/>
    <script src="http://code.jquery.com/jquery-1.11.1.min.js"></script>
    <script src="http://code.jquery.com/mobile/1.4.5/jquery.mobile-1.4.5.min.js"></script>
    <script src="https://smtpjs.com/v3/smtp.js"></script>

    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">

    <link rel="stylesheet" href="../css/custom2.css"/>
    <style>
        #outer-div {
            width: 100%;
            text-align: center;
        }

        #inner-div {
            display: inline-block;
            margin: 0 auto;
            padding: 3px;
        }
    </style>
</head>
<body>
<div data-role="page">
    <div class="top pl-3 pr-3 pb-2 fixed-top">
        <div data-role="header" class="mb-1 header">
            <button data-rel="back" id="backBtn" class="ui-btn ui-btn-icon-left ui-icon-back custom-back">Back</button>
            <h1>
                <img src="../assets/logos/MainLight.png" class="img-fluid" alt="Logo.png">
            </h1>
            <button class="ui-btn-right ui-btn ui-btn-icon-notext ui-icon-notification">Notification</button>
        </div>
        <div class="row justify-content-center">
            <div class="col-sm-10">
                <a href="#popupBasicLocation" data-rel="popup" data-transition="pop" id="selectLocation"
                   class="ui-btn ui-shadow ui-corner-all ui-btn-icon-left ui-icon-location custom-search-bar">Select
                    Your
                    Location</a>
            </div>
        </div>
        <div class="row mt-n2"> <!--first hr line-->
            <div class="col">
                <hr>
            </div>
        </div>
        <div class="row mt-n2">
            <div class="col"><span id="nav_bar_home_2">Home</span> / <span style="color: #F19B55">Favorites</span></div>
        </div>

        <!--Location Modal-->
        <div data-role="popup" id="popupBasicLocation" class="custom-location" data-position-to="window"
             data-overlay-theme="a" data-transition="pop">
            <div class="row mb-2">
                <div class="col-8">
                </div>
                <div class="col-4 custom-close-button">
                    <a href="#" data-rel="back" data-role="button" data-transition="pop"
                       class="ui-btn ui-icon-delete ui-btn-icon-notext ui-corner-all m-0">No text</a>
                </div>
            </div>
            <form>
                <div class="ui-input-search ui-body-inherit ui-corner-all ui-shadow-inset ui-input-has-clear">
                    <input data-type="search" data-enhanced="true" data-inset="false" id="pre-rendered-example-input"
                           placeholder="Search by locations..." value="">
                </div>
                <div data-role="controlgroup" data-enhanced="true" data-filter="true" data-filter-reveal="true"
                     data-input="#pre-rendered-example-input"
                     class="ui-controlgroup ui-controlgroup-vertical ui-corner-all">
                    <div class="ui-controlgroup-controls">
                        <a href="#"
                           class="ui-btn ui-corner-all ui-shadow ui-shadow ui-screen-hidden ui-btn-icon-left
                           ui-icon-location location" data-filtertext = "Colombo 10">Colombo
                            10</a>
                        <a href="#"
                           class="ui-btn ui-corner-all ui-shadow ui-first-child ui-shadow ui-last-child ui-btn-icon-left
                            ui-icon-location location" data-filtertext = "Colombo 11">Colombo
                            11</a>
                        <a href="#"
                           class="ui-btn ui-corner-all ui-shadow ui-shadow ui-screen-hidden ui-btn-icon-left
                           ui-icon-location location" data-filtertext = "Maradhana">Maradana</a>
                    </div>
                </div>
            </form>
        </div>
        <!--Filters Modal-->
        <div data-role="popup" id="popupBasic" class="custom-filter" data-position-to="window" data-overlay-theme="a"
             data-transition="pop">
            <div class="row mb-2">
                <div class="col-8">
                    <label><strong>Categories </strong> </label>
                </div>
                <div class="col-4 custom-close-button">
                    <a href="#" data-rel="back" data-role="button" data-transition="pop"
                       class="ui-btn ui-icon-delete ui-btn-icon-notext ui-corner-all m-0">No text</a>
                </div>
            </div>

            <form>
                <div class="row mb-3">
                    <div class="col-6">
                        <div class="row">
                            <div class="col-4">
                                <label for="flip-1">Pizza</label>
                            </div>
                            <div class="col-8 custom-switch">
                                <select name="flip-1" id="flip-1" data-role="slider" style="width: 4.0em;">
                                    <option value="off"></option>
                                    <option value="on"></option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="row">
                            <div class="col-4">
                                <label for="flip-2">Noodles</label>
                            </div>
                            <div class="col-8 custom-switch">
                                <select name="flip-2" id="flip-2" data-role="slider" style="width: 4.0em;">
                                    <option value="off"></option>
                                    <option value="on"></option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="row mb-3">
                    <div class="col-6">
                        <div class="row">
                            <div class="col-4">
                                <label for="flip-3">Bakery</label>
                            </div>
                            <div class="col-8 custom-switch">
                                <select name="flip-3" id="flip-3" data-role="slider" style="width: 4.0em;">
                                    <option value="off"></option>
                                    <option value="on"></option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="row">
                            <div class="col-4">
                                <label for="flip-4">Chinese</label>
                            </div>
                            <div class="col-8 custom-switch">
                                <select name="flip-4" id="flip-4" data-role="slider" style="width: 4.0em;">
                                    <option value="off"></option>
                                    <option value="on"></option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
            </form>
            <form>
                <div data-role="rangeslider">
                    <label for="range-1a" class="mb-3"><strong>Price Range (LKR)</strong></label>
                    <input type="range" name="range-1a" id="range-1a" min="0" max="100" value="40">
                    <label for="range-1b">Rangeslider:</label>
                    <input type="range" name="range-1b" id="range-1b" min="0" max="100" value="80">
                </div>
            </form>

            <div class="row mb-3 mt-3">
                <div class="col-6">
                    <a href="#" data-rel="back" data-role="button" class="ui-btn">Cancel</a>
                </div>
                <div class="col-6">
                    <button class="ui-btn">Apply</button>
                </div>
            </div>
        </div>

    </div>

    <div class="main"> <!--content area starts from here-->
        <div class="mr-2 ml-2">
            <div id="favouriteItems" class="container row m-0" style="max-width:100%">

            </div>
            <div id="emailMyList" class="row">
                <div class="col-12">
                   <div class="prd-modal-ctrl-btn pt-2 pb-2" style="font-size: 16px !important; text-align: center;" >
                       <a>
                           <span class="text-white">Email My List</span></a></div>
                </div>
            </div>

            <div id="outer-div" >
                <div id="inner-div" style="font-weight: bold;font-variant: all-small-caps;position: absolute;top: 50%;left: 50%;transform: translate(-50%, -50%);">No favorites items  available to display.</div>
            </div>
        </div>
    </div>



    <!--Submit Email details modal-->
    <div data-role="popup" id="popup-send-email" class="custom-location" data-position-to="window"
         data-overlay-theme="a" data-transition="pop" data-history="false">
        <div class="row mb-2">
            <div class="col-8">
            </div>
            <div class="col-4 custom-close-button">
                <a href="#" data-rel="back" data-role="button" data-transition="pop"
                   class="ui-btn ui-icon-delete ui-btn-icon-notext ui-corner-all m-0">No text</a>
            </div>
        </div>
        <div><h4>Email Me</h4></div>
        <div>
            <input type="email" id="emailTo" placeholder="To" style="color: #F19B55" required>
            <input type="text" id="emailSubject" placeholder="Subject" style="color: #F19B55">
            <div class="row mt-2 mb-2" style="align-items: center;">
                <div class="col-8" style="color: #282F33">
                    Send my favorites list as an attachment
                </div>
                <div class="col-4" style="text-align: -webkit-right;">
                    <a href="#" data-rel="back" data-role="button" data-transition="pop"
                       class="ui-btn ui-icon-check ui-btn-icon-notext ui-corner-all m-0" style="background-color: #EC7A23">No text</a>
                </div>
            </div>
            <button onclick="sendEmail()" style="background-color: #EC7A23;color: #FFFFFF;text-shadow:none !important;">Submit</button>
        </div>
    </div>

    <!--Success email modal-->
    <div data-role="popup" id="success-email" class="custom-location" data-position-to="window"
         data-overlay-theme="a" data-transition="pop" >
        <div class="row mb-2">
            <div class="col-8">
            </div>
            <div class="col-4 custom-close-button">
                <a href="#" data-rel="back" data-role="button" data-transition="pop"
                   class="ui-btn ui-icon-delete ui-btn-icon-notext ui-corner-all m-0">No text</a>
            </div>
        </div>
        <div class="mb-4" style="text-align: center;"><h6>Your Email Sent Successfully</h6></div>
        <div class="mb-2" style="text-align: center;"><img src="../assets/gifs/40635-quick-success.gif" style="width: 60px; height: 60px;"></div>

    </div>

    <!--Footer-->
    <div class="footer">
        <div class="row justify-content-between">
            <div class="col d-flex justify-content-left ml-3 p-3">
                <img src="../assets/logos/AltDark.png" class="img-fluid" alt="logo">
            </div>
            <div class="col mr-3 p-3">
                <div class="row">
                    <div class="col font1">Privacy Policy Terms of Use</div>
                    <div class="w-100"></div>
                    <div class="col font2">© 2020 HOMEAL. All rights reserved</div>
                </div>
            </div>
        </div>
    </div>

    <div data-role="footer" id="bottom-nav" class="fixed-bottom">
        <nav data-role="navbar">
            <ul>
                <li><a id="nav_bar_home" class="ui-btn ui-icon-home ui-btn-icon-top">Home</a></li>
                <li><a id="nav_bar_orders" class="ui-btn ui-icon-orders ui-btn-icon-top">Orders</a></li>
                <li><a id="nav_bar_cart" class="ui-btn ui-icon-cart ui-btn-icon-top">Cart</a></li>
                <li><a id="nav_bar_profile" class="ui-btn ui-icon-profile ui-btn-icon-top ui-state-persist">Profile</a></li>
            </ul>
        </nav>
    </div>

    <div data-role="panel" data-position="right" data-display="overlay" data-theme="a" id="side-drawer"
         style="z-index: 1400">
                
        <div><img src="../assets/logos/MainLight.png" class="side-drawer-logo"></div>
        <ul data-role="listview">
            <li data-icon="false"><a onclick='window.location.href="../profile/MyAccount.html"' class="side-drawer-option">My Account</a></li>
            <li data-icon="false"><a  onclick='window.location.href="../profile/Help-about.html"' class="side-drawer-option">Help/About</a></li>
            <li data-icon="false"><a  onclick='window.location.href="../profile/Favorites.html"' class="side-drawer-option"> Favorites</a></li>
            <li data-icon="false"><a  onclick='window.location.href="../profile/Acheivements.html"' class="side-drawer-option">Acheivements</a></li>
            <li data-icon="false"><a  id="profile_logout" class="side-drawer-option">Logout</a></li>
        </ul>
            
    </div>

</div>
</body>
<script src="../js/common.js"></script>
<script>
    let openSuccessEmailModal = false;
    $.mobile.ajaxEnabled = false;
    let user;
    let imgJsonArr;

    $(document).ready(function () {
        loadFavouriteList();
        imgJsonArr = [];
        $.getJSON("../data/FavoritesImagesMap.json", function (result) {
            imgJsonArr = result;
        });
    })

    function loadFavouriteList() {
        let favouriteItems = $("#favouriteItems");
        favouriteItems.empty(); // to remove previously loaded cards.
        user = JSON.parse(sessionStorage.getItem('user'));
        let favouriteListJson = user['favorites_list'];
        $("#outer-div").hide();
        $("#emailMyList").show();
        favouriteItems.show();
        if (favouriteListJson.length !== 0) {
            let favoriteCards = '';
            $.each(favouriteListJson, function (i, item) {
                let card = `
        <div class="col-sm-12 col-md-6 p-1">
                    <div class="maintxt" style="height: 150px;
                     background: linear-gradient(
                    rgba(0, 0, 0, 0.45),
                    rgba(0, 0, 0, 0.45)
                    ), /* bottom, image */ url(${item['merchant_bg']});
                    background-size: cover;
                    background-position: center !important;
                    border-radius: 10px;">
                        <div class="container overlay-text mt-2" style="position: absolute">
                            <div class="row col-12 m-0  p-0 star" data-pid="${item['product_id']}${item['merchant_id']}" >
                                <div class="col-12 m-0 p-0" style="text-align: -webkit-right;">
                                    <img src="../assets/icons/favorite.png"
                                         style="border-radius: 10px;  height: 25px;width:25px;!important; object-fit: cover;"
                                         alt="Card image">
                                </div>
                            </div>
                            <div class="row col-12 m-0 p-0">
                                <div class="col-12 m-0 p-0" style="text-align: -webkit-center;">
                                    <img src="${item['merchant_logo']}"
                                         style="border-radius: 10px;  height: 40px;width:40px;!important; object-fit: cover;"
                                         alt="Card image">
                                </div>
                            </div>
                            <div class="row col-12 m-0  p-0">
                                <div class="col-12 m-0 p-0 mt-2">
                                    <h5 class="text-white" style="text-align: -webkit-center; font-size: 12px">${item['merchant_name']}
                                     - ${item['location']}</h5>
                                </div>
                            </div>
                            <div class="row col-12 m-0  p-0">
                                <div class="col-12 m-0 p-0 mt-1">
                                    <h5 class="text-white" style="text-align: -webkit-center;">${item['product_name']}</h5>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
        `;
                favoriteCards += card;
            });
            favouriteItems.append(favoriteCards);
        } else {
            favouriteItems.hide();
            $("#emailMyList").hide();
            $("#outer-div").show();
        }
    }

    $(document).on('click', '.star', function() {
        let selected_product_id = $(this).data('pid');
        let favouriteListJson = user['favorites_list'];
        user['favorites_list'] = $.grep(favouriteListJson, function(item){
            let id = item['product_id'] + item['merchant_id'];
            return id !== selected_product_id;
        });
        sessionStorage.setItem('user', JSON.stringify(user));
        loadFavouriteList()
    });

    $( "#backBtn" ).click(function() {
        window.history.back();
    });
    $( "#emailMyList" ).click(function() {
        $("#popup-send-email").popup('open');
    });

    function sendEmail() {
        let emailAddress = $("#emailTo").val();
        let emailReg = /^([\w-\.]+@([\w-]+\.)+[\w-]{2,4})?$/;
        let isEmail = emailReg.test(emailAddress) && emailAddress !== '';
        if (isEmail && emailAddress !== '') {
            let subject = $("#emailSubject").val();
            if (subject === '') {
                subject = 'Hey!, Checkout My Favourite List';
            }
            let msgBody = `
            <table style="border-collapse: collapse; table-layout: fixed; background: #f6f6f6; margin: 20px 0;"
            border="0" width="80%" cellspacing="0" cellpadding="20">
                <tbody>
                <tr>
                    <td><img style="width: 100px; margin-bottom: 10px;" src="https://i.postimg.cc/ZRhJCYNP/Main-Light.png"/>
                        <p style="margin-top: 0; font-size: 90%;">Dear Customer,</p>
                           <p style="margin-top: 0; font-size: 90%;">We hope you enjoy using our app as much as we have enjoyed making it four you. <br>
The below attached is the list of your favorites items from our local restaurants.</p>
                 <div>
                   <table>
            `;
            let favouriteListJson = user['favorites_list'];
            $.each(favouriteListJson, function (i, item) {
                let imgJson = imgJsonArr.find(x => x['product_id'] === item['product_id']
                    & x['merchant_id'] === item['merchant_id']);
                let imgPath = '';
                if (imgJson) {
                    imgPath = imgJson['product_url'];
                }
                msgBody += `
                <tr>
                   <td>
                        <div style="border-radius:20px"><img src="${imgPath}"
                                style="height:40px;width:60px;border-radius:500px" class="CToWUd">

                        </div>
                   </td>
                   <td>
                        <div>
                           <span style="font-weight:bold;padding-left: 10px">${item['product_name']}</span>
                        </div>
                   </td>
                </tr>
                `;
            });
            msgBody += `</table>
                 </div>
                        <p style="margin-bottom: 2px; font-size: 90%;">Have a great day!</p>
                        <p style="margin-bottom: 2px; font-size: 90%;">Thank You,</p>
                        <p style="margin-top: 0; font-size: 90%;color:#ec7a23; ">HOMEAL Team</p>
                    </td>
                </tr>
                </tbody>
            </table>`;
            let emailPromise = Email.send({
                Host: "smtp.gmail.com",
                Username: "lkhomeal@gmail.com",
                Password: "1234@abcd",
                To: emailAddress,
                From: "lkhomeal@gmail.com",
                Subject: subject,
                Port: 587,
                Body: msgBody,
            });
            emailPromise.then(function (message) {
                console.log(message);
                if (message === 'OK') {
                    openSuccessEmailModal = true;
                    popupSuccessEmailModal();
                    $('#emailTo').val('');
                    $('#emailSubject').val('');
                } else {
                    alert('An error occurred while sending the email. Please resend the email.')
                }
            });
        } else {
            alert('Invalid email address. Please check whether the given email address is valid.')
        }
    }

    function popupSuccessEmailModal() {
        let sendEmailModal = $("#popup-send-email");
        sendEmailModal.popup('close');
        sendEmailModal.on("popupafterclose", function () {
            //any action you want like opening another popup
            if (openSuccessEmailModal) {
                let successEmailModal = $("#success-email");
                successEmailModal.popup("open");
                successEmailModal.on("popupafterclose", function () {
                    openSuccessEmailModal = false;
                });
            }
        });
    }
</script>
<script src="../js/location.js"></script>
</html>
